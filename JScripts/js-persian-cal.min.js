// JS Persian Calendar 0.1.5 - by AMIB
// 1391/02/27
// http://amib.ir/weblog
// amib@amib.ir
var AMIB={},lastOpenPDatePickerID=false,lastOpenPDateMonthYearID=false,pDatePickerZIndex=1E3,arrPersianMonthNames="\u0641\u0631\u0648\u0631\u062f\u06cc\u0646,\u0627\u0631\u062f\u0628\u06cc\u0647\u0634\u062a,\u062e\u0631\u062f\u0627\u062f,\u062a\u06cc\u0631,\u0645\u0631\u062f\u0627\u062f,\u0634\u0647\u0631\u06cc\u0648\u0631,\u0645\u0647\u0631,\u0622\u0628\u0627\u0646,\u0622\u0630\u0631,\u062f\u06cc,\u0628\u0647\u0645\u0646,\u0627\u0633\u0641\u0646\u062f".split(","),arrShortWeekdayNames="\u0634,\u06cc\u06a9,\u062f\u0648,\u0633\u0647,\u0686\u0647,\u067e\u0646,\u062c\u0645".split(",");
if(typeof A$!=="function")var A$=function(b){return document.getElementById(b)};if(typeof A$$!=="function")var A$$=function(b,a){return b.getElementsByTagName(a)};if(typeof cE!=="function")var cE=function(b){return document.createElement(b)};if(typeof cTN!=="function")var cTN=function(b){return document.createTextNode(b)};
AMIB.persianCalendar=function(b,a,c){var d,h={oPersianID:"",oExtraInputID:"",ExtraInputFormat:"JD",autoCreateButton:true,divPickerClassName:"picker",btnClassName:"pcalBtn"};this.instanceID=b;this.oldDocumentOnClick=false;h.oPersianID=a;for(d in c)h[d]=c[d];b=A$(a);if(h.autoCreateButton)a=cE("a"),a.className=h.btnClassName,a.href="#",b.parentNode.insertBefore(a,b.nextSibling),a.onclick=function(b){return function(i){window[b].showHidePicker(i);return false}}(this.instanceID);b.ondblclick=function(b){return function(i){window[b].showHidePicker(i);
return false}}(this.instanceID);b.onblur=function(b){return function(){window[b].normalizeUserInput()}}(this.instanceID);b.onkeydown=acceptDateChars;this.showHidePicker=function(b){var i=this.instanceID+"_pDatePicker",a;if(a=A$(i)){if(a.parentNode.removeChild(a),document.onclick=this.oldDocumentOnClick,lastOpenPDatePickerID=this.oldDocumentOnClick=false,b=A$(lastOpenPDateMonthYearID))b.parentNode.removeChild(b),lastOpenPDateMonthYearID=false}else{var c=A$(h.oPersianID);a=cE("div");a.id=i;a.className=
h.divPickerClassName;i=getOffset(c);this.createDateTable(a,c.value,c.value);document.body.appendChild(a);a.style.top=i.top-a.offsetHeight<0||getScrollTop()+getViewPortHeight()>i.top+c.offsetHeight+a.offsetHeight?i.top+c.offsetHeight+"px":i.top-a.offsetHeight+"px";a.style.left=i.left+c.offsetWidth-a.offsetWidth+"px";a.style.zIndex=!lastOpenPDatePickerID?pDatePickerZIndex=1E3:++pDatePickerZIndex;if(typeof b=="undefined")b=window.event;lastOpenPDatePickerID&&window[lastOpenPDatePickerID].showHidePicker(b);
lastOpenPDatePickerID=this.instanceID;stopPropagation(b);this.oldDocumentOnClick=document.onclick;document.onclick=function(b,a){return function(){window[b].showHidePicker(a)}}(this.instanceID,b)}};this.createDateTable=function(b,a,c){var d=cE("table"),f,g,e,j,l;A$(h.oPersianID);var k;k=new Date;g=gregorian_to_jd(k.getFullYear(),k.getMonth()+1,k.getDate());k=jd_to_persian(g);c=isPersianDate(c);if(a=isPersianDate(a))g=persian_to_jd(a[0],a[1],a[2]);var a=jd_to_persian(g),m=Math.floor(persian_to_jd(a[0],
a[1],1)+3)%7;f=d.insertRow(-1);g=f.insertCell(-1);g.className="pickerHead";g.colSpan=7;f=cE("div");f.className="navBack";e=cE("a");e.appendChild(cTN("\u00ab"));e.title="\u0633\u0627\u0644 \u0642\u0628\u0644";e.className="nav";e.href="#";e.onclick=function(b,a,c){return function(i){window[b].changePickerDate(i,a,c);return false}}(this.instanceID,a[0]-1,a[1]);f.appendChild(e);e=cE("a");e.appendChild(cTN("<"));e.title=arrPersianMonthNames[a[1]==1?11:a[1]-2];e.className="nav";e.href="#";e.onclick=function(b,
a,c){return function(i){window[b].changePickerDate(i,a,c);return false}}(this.instanceID,a[1]==1?a[0]-1:a[0],a[1]==1?12:a[1]-1);f.appendChild(e);g.appendChild(f);f=cE("div");f.className="navFwd";e=cE("a");e.appendChild(cTN("\u00bb"));e.title="\u0633\u0627\u0644 \u0628\u0639\u062f";e.className="nav";e.href="#";e.onclick=function(b,a,c){return function(i){window[b].changePickerDate(i,a,c);return false}}(this.instanceID,a[0]+1,a[1]);f.appendChild(e);e=cE("a");e.appendChild(cTN(">"));e.title=arrPersianMonthNames[a[1]==
12?0:a[1]];e.className="nav";e.href="#";e.onclick=function(b,a,c){return function(i){window[b].changePickerDate(i,a,c);return false}}(this.instanceID,a[1]==12?a[0]+1:a[0],a[1]==12?1:a[1]+1);f.appendChild(e);g.appendChild(f);e=cE("a");e.className="monYear";e.appendChild(cTN(arrPersianMonthNames[a[1]-1]));e.href="#";e.onclick=function(b,a,c){return function(i){window[b].showMonthPicker(i,a,c);return false}}(this.instanceID,a[1],a[0]);g.appendChild(e);e=cE("a");e.className="monYear";e.appendChild(cTN(ConvertEnglishNumsToPersian(a[0])));
e.href="#";e.onclick=function(b,a,c){return function(i){window[b].showYearPicker(i,a,c);return false}}(this.instanceID,a[1],a[0]);g.appendChild(e);f=d.insertRow(-1);for(j=0,l=arrShortWeekdayNames.length;j<l;++j)g=f.insertCell(-1),g.appendChild(cTN(arrShortWeekdayNames[j])),g.className="calWeekdays";f=d.insertRow(-1);for(j=0;j<m;++j)g=f.insertCell(-1);for(j=m,l=persianMonthDays(a[0],a[1])+m;j<l;++j)j%7==0&&(f=d.insertRow(-1)),g=f.insertCell(-1),e=cE("a"),e.href="#",a[2]=j-m+1,e.className="weekday",
j%7==6&&(e.className+=" friday"),c&&a[2]==c[2]&&a[1]==c[1]&&a[0]==c[0]&&(e.className+=" selected"),a[2]==k[2]&&a[1]==k[1]&&a[0]==k[0]&&(e.className+=" today",e.title+="\u0627\u0645\u0631\u0648\u0632"),e.onclick=function(b,a){return function(){window[b].fillDateField(a);return false}}(this.instanceID,a.join("/")),e.appendChild(cTN(ConvertEnglishNumsToPersian(a[2]))),g.appendChild(e);for(j=0,l=7-(persianMonthDays(a[0],a[1])+m)%7;l!=7&&j<l;++j)g=f.insertCell(-1);f=d.insertRow(-1);g=f.insertCell(-1);
g.className="pickerFoot";g.colSpan=7;e=cE("a");e.appendChild(cTN(ConvertEnglishNumsToPersian("\u0627\u0645\u0631\u0648\u0632: "+k[2].toString()+" "+arrPersianMonthNames[k[1]-1].toString()+" "+k[0].toString())));e.href="#";a[2]=j-m+1;e.onclick=function(b,a){return function(){window[b].fillDateField(a);return false}}(this.instanceID,k.join("/"));for(g.appendChild(e);b.firstChild;)b.removeChild(b.firstChild);b.appendChild(d)};this.changePickerDate=function(b,a,c){var d;if(d=A$(this.instanceID+"_pDatePicker")){if(!b)b=
window.event;stopPropagation(b);b=a.toString()+"/"+c.toString()+"/1";this.createDateTable(d,b,A$(h.oPersianID).value)}};this.showMonthPicker=function(b,a,c){var d,f,g;if(A$(this.instanceID+"_pDatePicker")){if(!b)b=window.event;(f=A$(lastOpenPDateMonthYearID))&&f.parentNode.removeChild(f);stopPropagation(b);f=cE("div");f.className="monthYearPicker";f.id=lastOpenPDateMonthYearID=this.instanceID+"monthYearPicker";for(d=0;d<12;++d){g=cE("a");g.href="#";g.appendChild(cTN(arrPersianMonthNames[d]));if(d==
a-1)g.className="selected";g.onclick=function(b,a,c){return function(i){window[b].monthYearPickerClick(i,a,c);return false}}(this.instanceID,d+1,c);f.appendChild(g)}document.body.appendChild(f);f.style.left=b.clientX-20+"px";f.style.top=b.clientY+5+"px";f.style.zIndex=++pDatePickerZIndex}};this.showYearPicker=function(b,a,c){var d,f,g;if(A$(this.instanceID+"_pDatePicker")){if(!b)b=window.event;(f=A$(lastOpenPDateMonthYearID))&&f.parentNode.removeChild(f);stopPropagation(b);f=cE("div");f.className=
"monthYearPicker";f.id=lastOpenPDateMonthYearID=this.instanceID+"monthYearPicker";for(d=c-5;d<=c+5;++d){g=cE("a");g.href="#";g.appendChild(cTN(ConvertEnglishNumsToPersian(d)));if(d==c)g.className="selected";g.onclick=function(b,a,c){return function(d){window[b].monthYearPickerClick(d,a,c);return false}}(this.instanceID,a,d);f.appendChild(g)}document.body.appendChild(f);f.style.left=b.clientX-20+"px";f.style.top=b.clientY+5+"px";f.style.zIndex=++pDatePickerZIndex}};this.monthYearPickerClick=function(b,
a,c){var d,f;if(d=A$(this.instanceID+"_pDatePicker")){if(!b)b=window.event;stopPropagation(b);(f=A$(lastOpenPDateMonthYearID))&&f.parentNode.removeChild(f);lastOpenPDateMonthYearID=false;b=c.toString()+"/"+a.toString()+"/1";this.createDateTable(d,b,A$(h.oPersianID).value)}};this.normalizeUserInput=function(){var b=A$(h.oPersianID),a;a=b.value.trim();a=ConvertPersianNumsToEnglish(a);if(a=isPersianDate(a))this.fillDateField(a.join("/"));else if(a=removeCssClass(b.className,"valid"),a=removeCssClass(a,
"invalid"),b.className=a+" invalid",h.oExtraInputID.length)A$(h.oExtraInputID).value=""};this.fillDateField=function(b){var a=A$(h.oPersianID),c=isPersianDate(b);a.value=b;b=removeCssClass(a.className,"invalid");b=removeCssClass(b,"valid");a.className=b+" valid";if(h.oExtraInputID.length&&h.ExtraInputFormat.length)a=h.ExtraInputFormat,a=a.replace(/yyyy/g,zeroPad(c[0],4)),a=a.replace(/mm/g,zeroPad(c[1],2)),a=a.replace(/dd/g,zeroPad(c[2],2)),a=a.replace(/yy/g,zeroPad(c[0]%100,2)),a=a.replace(/m/g,c[1].toString()),
a=a.replace(/d/g,c[2].toString()),c=persian_to_jd(c[0],c[1],c[2]),a=a.replace(/JD/g,c),c=jd_to_gregorian(c),a=a.replace(/YYYY/g,zeroPad(c[0],4)),a=a.replace(/MM/g,zeroPad(c[1],2)),a=a.replace(/DD/g,zeroPad(c[2],2)),a=a.replace(/YY/g,zeroPad(c[0]%100,2)),a=a.replace(/M/g,c[1].toString()),a=a.replace(/D/g,c[2].toString()),A$(h.oExtraInputID).value=a}};
function acceptDateChars(b){if(!b)b=window.event;if(window.event)b=b.keyCode;else if(b.which)b=b.which;else return false;return b>=48&&b<=57||b>=96&&b<=105||b===191||b===111||b===8||b===9||b===13||b===46||b===109||b>=35&&b<=40?true:false}function stopPropagation(b){if(typeof b!="undefined")b.stopPropagation?b.stopPropagation():b.cancelBubble=true}
function isPersianDate(b){var a;if(b.search(/^\d+\-\d+\-\d+$/)==0)a=b.split("-",3);else if(b.search(/^\d+\/\d+\/\d+$/)==0)a=b.split("/",3);else if(b.search(/^\d{6}|\d{8}$/)==0)a=[b.substr(0,b.length-4),b.substr(b.length-4,2),b.substr(b.length-2,2)];else if((a=b.match(/^(\d{2})(\d{2})$/))||(a=b.match(/^(\d{1,2})[/\-](\d{1,2})$/))||(a=b.match(/^(\d{1,2})$/)))b=new Date,b=gregorian_to_jd(b.getFullYear(),b.getMonth()+1,b.getDate()),b=jd_to_persian(b),a[0]=b[0],typeof a[2]=="undefined"&&(a[2]=b[1]),parseInt(a[2],
10)<=12&&(b=a[1],a[1]=a[2],a[2]=b);else return false;for(b=0;b<=2;++b)a[b]=parseInt(a[b],10);if(a[1]>12||a[1]<=0)return false;a[2]>persianMonthDays(longYear(a[0]),a[1])&&(b=a[2],a[2]=a[0],a[0]=b);if(a[0]>9999)return false;a[0]<100&&(a[0]=longYear(a[0]));return a[2]===0||a[2]>persianMonthDays(a[0],a[1])?false:a}
function ConvertPersianNumsToEnglish(b){for(var a=b.length,c="",d=0,d=0;d<a;++d)c+=String.fromCharCode(b.charCodeAt(d)>=1776&&b.charCodeAt(d)<=1785?b.charCodeAt(d)-1728:b.charCodeAt(d));return c}function ConvertEnglishNumsToPersian(b){for(var b=b.toString(),a=b.length,c="",d=0,d=0;d<a;++d)c+=String.fromCharCode(b.charCodeAt(d)>=48&&b.charCodeAt(d)<=57?b.charCodeAt(d)+1728:b.charCodeAt(d));return c}
if(!("trim"in String.prototype))String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")};if(!("map"in Array.prototype))Array.prototype.map=function(b,a){for(var c=Array(this.length),d=0,h=this.length;d<h;d++)d in this&&(c[d]=b.call(a,this[d],d,this));return c};function longYear(b){var a,c;if(b>=100)return b;a=new Date;a=gregorian_to_jd(a.getFullYear(),a.getMonth()+1,a.getDate());a=jd_to_persian(a);c=Math.floor(a[0]/100)*100;Math.abs(a[0]-c-b)>70&&(c+=100);return c+b}
var GREGORIAN_EPOCH=1721425.5,PERSIAN_EPOCH=1948320.5;function mod(b,a){return b-a*Math.floor(b/a)}function leap_persian(b){return((b-(b>0?474:473))%2820+512)*682%2816<682}
function jd_to_persian(b){var a,c,d,b=Math.floor(b)+0.5;c=b-persian_to_jd(475,1,1);a=Math.floor(c/1029983);d=mod(c,1029983);d==1029982?c=2820:(c=Math.floor(d/366),d=mod(d,366),c=Math.floor((2134*c+2816*d+2815)/1028522)+c+1);a=c+2820*a+474;a<=0&&a--;c=b-persian_to_jd(a,1,1)+1;c=c<=186?Math.ceil(c/31):Math.ceil((c-6)/30);b=b-persian_to_jd(a,c,1)+1;return[a,c,b]}
function persian_to_jd(b,a,c){var d;b-=b>=0?474:473;d=474+mod(b,2820);return c+(a<=7?(a-1)*31:(a-1)*30+6)+Math.floor((d*682-110)/2816)+(d-1)*365+Math.floor(b/2820)*1029983+(PERSIAN_EPOCH-1)}function leap_gregorian(b){return b%4==0&&!(b%100==0&&b%400!=0)}
function jd_to_gregorian(b){var a,c,d,h,b=Math.floor(b-0.5)+0.5;a=b-GREGORIAN_EPOCH;c=Math.floor(a/146097);d=mod(a,146097);a=Math.floor(d/36524);h=mod(d,36524);d=Math.floor(h/1461);h=mod(h,1461);h=Math.floor(h/365);c=c*400+a*100+d*4+h;a==4||h==4||c++;a=b-gregorian_to_jd(c,1,1);d=b<gregorian_to_jd(c,3,1)?0:leap_gregorian(c)?1:2;a=Math.floor(((a+d)*12+373)/367);b=b-gregorian_to_jd(c,a,1)+1;return[c,a,b]}
function gregorian_to_jd(b,a,c){return GREGORIAN_EPOCH-1+365*(b-1)+Math.floor((b-1)/4)+-Math.floor((b-1)/100)+Math.floor((b-1)/400)+Math.floor((367*a-362)/12+(a<=2?0:leap_gregorian(b)?-1:-2)+c)}function persianMonthDays(b,a){return a<=6?31:a<=11?30:a==12?leap_persian(b)?30:29:0}function removeCssClass(b,a){return b.split(/\s+/).map(function(b){return b===a?"":b}).join(" ")}
function getOffset(b){for(var a=0,c=0;b&&!isNaN(b.offsetLeft)&&!isNaN(b.offsetTop);)a+=b.offsetLeft,c+=b.offsetTop,b=b.offsetParent;return{top:c,left:a}}function zeroPad(b,a){var c=Math.abs(b),d=Math.max(0,a-Math.floor(c).toString().length),d=Math.pow(10,d).toString().substr(1);b<0&&(d="-"+d);return d+c}
function getViewPortHeight(){return typeof window.innerWidth!="undefined"?window.innerHeight:document.documentElement&&document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight}function getScrollTop(){if(typeof pageYOffset!="undefined")return pageYOffset;else{var b=document.body;D=document.documentElement;D=D.clientHeight?D:b;return D.scrollTop}};
